!function(e,t){function n(e,t,n){return n?void(this["_"+e]=t):this["_"+e]}var r=(e.Aurigma||(e.Aurigma={__namespace:!0}))&&(e.Aurigma.ImageUploaderFlash||(e.Aurigma.ImageUploaderFlash={__namespace:!0}));r.language||(r.language={__namespace:!0});var a=r;r.amazonS3Extender=function(e){if(!(this instanceof r.amazonS3Extender))return new r.amazonS3Extender(e);1==e.state()&&a.debug().showError("AmazonS3Extender should be created before uploader initialization."),e.amazonS3Extender(this),this._uploader=e,this._converters=new r.amazonS3Extender.converters,this._converterIndex=-1;var t=this;e.events().beforeSendRequest().add(function(){return t._onBeforeSendRequest.apply(t,arguments)}),e.events().initComplete().add(function(){return t._onInitComplete.apply(t,arguments)}),e.events().beforeUpload().add(function(){return t._onBeforeUpload.apply(t,arguments)})},r.amazonS3Extender.prototype={__class:!0,predefinedFields:{description:"Description_[itemIndex]",width:"Width_[itemIndex]",height:"Height_[itemIndex]",angle:"Angle_[itemIndex]",sourceName:"SourceName_[itemIndex]",horizontalResolution:"HorizontalResolution_[itemIndex]",verticalResolution:"VerticalResolution_[itemIndex]",sourceFileSize:"SourceSize_[itemIndex]",sourceCreatedDateTime:"SourceCreatedDateTime_[itemIndex]",sourceLastModifiedDateTime:"SourceLastModifiedDateTime_[itemIndex]",sourceCreatedDateTimeLocal:"SourceCreatedDateTimeLocal_[itemIndex]",sourceLastModifiedDateTimeLocal:"SourceLastModifiedDateTimeLocal_[itemIndex]",thumbnailSucceeded:"Thumbnail[converterIndex]Succeeded_[itemIndex]",fileMode:"File[converterIndex]Mode_[itemIndex]",fileSize:"File[converterIndex]Size_[itemIndex]",fileWidth:"File[converterIndex]Width_[itemIndex]",fileHeight:"File[converterIndex]Height_[itemIndex]",fileName:"File[converterIndex]Name_[itemIndex]",packageFileCount:"PackageFileCount",packageIndex:"PackageIndex",packageCount:"PackageCount",packageGuid:"PackageGuid",cropBounds:"CropBounds_[itemIndex]"},_prop:n,bucket:function(e){return this._prop("bucket",e,arguments.length)},accessKeyId:function(e){return this._prop("accessKeyId",e,arguments.length)},region:function(e){return this._prop("region",e,arguments.length)},bucketHostName:function(e){return this._prop("bucketHostName",e,arguments.length)},checkIntegrity:function(e){return this._prop("checkIntegrity",e,arguments.length)},converters:function(e){return 0==arguments.length?this._converters:void this._converters.set(e)},_onBeforeSendRequest:function(e,t,n,r){var a=this._uploader,i=++this._converterIndex%this._converterCount,o=a.metadata(),s="x-amz-meta-",d=a.files().get(r);o.enableAllStandardFields(!1),o.resetCustomFields();var l=this._getNowString();o.addCustomField("x-amz-credential",this.accessKeyId()+"/"+l+"/"+this.region()+"/s3/aws4_request"),o.addCustomField("x-amz-algorithm","AWS4-HMAC-SHA256"),o.addCustomField("x-amz-date",l+"T000000Z"),o.addCustomField("success_action_status","200"),o.enableStandardField("File[converterIndex]_[itemIndex]",!0),o.renameStandardField("File[converterIndex]_[itemIndex]","file"),this.checkIntegrity()&&(o.enableStandardField("File[converterIndex]HashCodeMD5_[itemIndex]",!0),o.renameStandardField("File[converterIndex]HashCodeMD5_[itemIndex]","Content-MD5"));var u=this.converters().get((i+this._converterCount-1)%this._converterCount).meta();if(u&&u.length>0)for(var c=0,m=u.length;m>c;c++){var h=u[c];h.name&&null!=h.value&&o.removeCustomField(s+h.name)}var g=this.converters().get(i);if(g){var p=g.key()?g.key():"",f=/\$\{fileName\}/gi,_=/\$\{guid\}/gi,x=/\$\{path\}/gi;if(x.test(p)&&(p=p.replace(x,a.files().get(0).relativePath()).replace(/[\\]+|[/]+/g,"/")),f.test(p)&&(p=p.replace(f,t)),_.test(p)){var v=t.lastIndexOf("."),S=v>-1?t.substr(v,t.length):"";p=p.replace(_,n+S)}o.addCustomField("acl",g.acl()),o.addCustomField("key",p),o.addCustomField("policy",g.policy()),o.addCustomField("x-amz-signature",g.signature());var I=g.contentType();null!=I&&""!=I&&o.addCustomField("Content-Type",I),g.cacheControl()&&o.addCustomField("Cache-Control",g.cacheControl()),g.expires()&&o.addCustomField("Expires",g.expires()),g.storageClass()&&o.addCustomField("x-amz-storage-class",g.storageClass());var C=g.meta();if(C&&C.length>0)for(var c=0,m=C.length;m>c;c++){var h=C[c],F=h.name;if(F){var y=C[c].value,z=C[c].field;if(null!=z)if(/exif/i.test(z)){var E=d.exif()[z.replace(/exif/i,"")];o.addCustomField(s+F,"undefined"==typeof E?"":E)}else if(/iptc/i.test(z)){var E=d.iptc()[z];o.addCustomField(s+F,"undefined"==typeof E?"":E)}else o.enableStandardField(z,!0),o.renameStandardField(z,s+F);else null!=y&&o.addCustomField(s+F,y)}}}this._converterIndex=i},_getNowString:function(){var e=new Date,t=e.getFullYear().toString(),n=(e.getMonth()+1).toString();t+=1==n.length?"0"+n:n;var r=e.getDate().toString();return t+=1==r.length?"0"+r:r},_onInitComplete:function(){var t=this._uploader,n=this.bucketHostName()?this.bucketHostName():this.bucket()+".s3.amazonaws.com",r=t.uploadSettings();r.actionUrl(e.location.protocol+"//"+n+"/"),r.uploadConverterOutputSeparately(!0),r.filesPerPackage(1),"java"==t.type()&&r.enableHeadRequest(!1),r.chunkSize(0),this.region()||a.debug().showError("Now you must specify the region field along with other AmazonS3Extender settings."),t.metadata().uploadRequestHeaders({})},_onBeforeUpload:function(){this._converterCount=this._uploader.converters().count(),this._converterIndex=-1;for(var e=this._uploader.converters(),t=this.checkIntegrity()?"MD5BASE64":"",n=0,r=e.count();r>n;n++)e.get(n).hash(t)}},r.amazonS3Extender.prototype.constructor=r.amazonS3Extender,r.amazonS3Extender.converters=function(){return this instanceof r.amazonS3Extender.converters?void(this._list={}):new r.amazonS3Extender.converters},r.amazonS3Extender.converters.prototype={__class:!0,clear:function(){this._list={}},count:function(){return Object.keys(this._list).length},get:function(e){return this._list[e]||(this._list[e]=new r.amazonS3Extender.fileSettings),this._list[e]},remove:function(e){this._list.splice(e,1)},set:function(e){for(var t=0,n=e.length;n>t;t++){var a=new r.amazonS3Extender.fileSettings,i=e[t];this._list[t]=a;for(var o in i)(!i.hasOwnProperty||i.hasOwnProperty(o))&&("function"==typeof a[o]?a[o](i[o]):showWarning('$au.amazonS3Extender.fileSettings has not "'+o+'" property.'))}}},r.amazonS3Extender.converters.prototype.constructor=r.amazonS3Extender.converters,r.amazonS3Extender.fileSettings=function(){return this instanceof r.amazonS3Extender.fileSettings?void(this._meta=[]):new r.amazonS3Extender.fileSettings},r.amazonS3Extender.fileSettings.prototype={__class:!0,_prop:n,acl:function(e){return this._prop("acl",e,arguments.length)},key:function(e){return this._prop("key",e,arguments.length)},policy:function(e){return this._prop("policy",e,arguments.length)},signature:function(e){return this._prop("signature",e,arguments.length)},contentType:function(e){return this._prop("contentType",e,arguments.length)},storageClass:function(e){return this._prop("storageClass",e,arguments.length)},cacheControl:function(e){return this._prop("cacheControl",e,arguments.length)},expires:function(e){return this._prop("expires",e,arguments.length)},meta:function(e){return this._prop("meta",e,arguments.length)}},r.amazonS3Extender.fileSettings.prototype.constructor=r.amazonS3Extender.fileSettings,e.$au||"undefined"==typeof a||(e.$au=a),e.$au&&(e.$au.imageUploaderFlash=a.imageUploaderFlash)}(window);